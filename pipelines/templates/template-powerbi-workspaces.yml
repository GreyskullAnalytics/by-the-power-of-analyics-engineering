parameters:
- name: keyVaultName
  type: string
  default: "keyvault-name"
- name: subscription
  type: string
  default: "subscription-name"
- name: folderPath
  type: string
  default: "powerbi/workspaces"
- name: environment
  type: string
  default: "development"

steps:
- checkout: self
- task: AzureKeyVault@2
  inputs:
    azureSubscription: '${{ parameters.subscription }}'
    KeyVaultName: '${{ parameters.keyVaultName }}'
    SecretsFilter: 'Aggreg8-PBI-Tenant-Name, Aggreg8-PBI-Admin-API-App-ID, Aggreg8-PBI-Admin-API-Secret'
    RunAsPreJob: false

- task: CmdLine@2
  displayName: "Install python packages"    
  inputs:
    script: |
      pip3 install requests
      pip3 install msal
      echo

- task: PythonScript@0
  displayName: "Create Power BI Workspace"
  inputs:
    scriptSource: 'filePath' 
    scriptPath: pipelines/pipelinescripts/CreateWorkspaceFromConfig.py
  env:
    TENANT_NAME: $(Aggreg8-PBI-Tenant-Name)
    CLIENT_ID: $(Aggreg8-PBI-Admin-API-App-ID)
    CLIENT_SECRET: $(Aggreg8-PBI-Admin-API-Secret)
    FOLDER_PATH: '${{ parameters.folderPath }}'
    ENVIRONMENT: '${{ parameters.environment }}'
    